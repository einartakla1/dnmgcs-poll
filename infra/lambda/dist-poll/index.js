"use strict";var A=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var h=(o,e)=>{for(var s in e)A(o,s,{get:e[s],enumerable:!0})},S=(o,e,s,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let d of N(e))!g.call(o,d)&&d!==s&&A(o,d,{get:()=>e[d],enumerable:!(a=O(e,d))||a.enumerable});return o};var b=o=>S(A({},"__esModule",{value:!0}),o);var L={};h(L,{handler:()=>v});module.exports=b(L);var E=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),x=new E.DynamoDBClient({}),m=r.DynamoDBDocumentClient.from(x),C=process.env.TABLE_POLLS,P=process.env.TABLE_VOTERS,R=(process.env.ALLOWED_ORIGINS||"").split(","),D=process.env.NODE_ENV||"dev",k=process.env.PUBLIC_API_KEY;function t(o,e,s){let a={"Content-Type":"application/json"};return s&&R.includes(s)&&(a["Access-Control-Allow-Origin"]=s,a["Access-Control-Allow-Credentials"]="true"),{statusCode:o,headers:a,body:JSON.stringify(e)}}function V(o){return o.requestContext.identity?.sourceIp||o.headers["x-forwarded-for"]?.split(",")[0]||"unknown"}var v=async o=>{let e=o.headers?.origin||o.headers?.Origin,s=o.httpMethod,a=o.path;if(s==="OPTIONS")return{statusCode:200,headers:{"Access-Control-Allow-Origin":e||"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, x-api-key"},body:""};if(!o.headers["x-api-key"])return t(401,{error:"Missing API key"},e);try{if(s==="GET"&&a.includes("results")){let n=o.queryStringParameters||{},c=n.pollId,u=n.voterToken;if(!c)return t(400,{error:"Missing pollId"},e);let l=(await m.send(new r.GetCommand({TableName:C,Key:{pollId:c}}))).Item;if(!l)return t(404,{error:"Poll not found"},e);let i=typeof l.options=="string"?JSON.parse(l.options):l.options,p=String(l.showVoteCount)!=="false",I=!1;u&&(I=!!(await m.send(new r.GetCommand({TableName:P,Key:{pollId:c,voterToken:u}}))).Item);let f=i.reduce((y,w)=>y+(w.votes||0),0);return t(200,{question:l.question,options:i,totalVotes:f,hasVoted:I,status:l.status||"active",isClosed:l.status==="closed",showVoteCount:p},e)}if(s==="POST"&&a.includes("vote")){if(!o.body)return t(400,{error:"Missing body"},e);let{pollId:n,optionId:c,voterToken:u}=JSON.parse(o.body);if(!n||c===void 0||!u)return t(400,{error:"Missing params"},e);let T=V(o);console.log(`Vote from ${T}`);let i=(await m.send(new r.GetCommand({TableName:C,Key:{pollId:n}}))).Item;if(!i)return t(404,{error:"Poll not found"},e);if(i.status==="closed")return t(403,{error:"Poll is closed"},e);let p=typeof i.options=="string"?JSON.parse(i.options):i.options;if(!p[c])return t(400,{error:"Invalid option"},e);if((await m.send(new r.GetCommand({TableName:P,Key:{pollId:n,voterToken:u}}))).Item)return t(400,{error:"Already voted"},e);p[c].votes=(p[c].votes||0)+1,await m.send(new r.UpdateCommand({TableName:C,Key:{pollId:n},UpdateExpression:"SET #o = :o",ExpressionAttributeNames:{"#o":"options"},ExpressionAttributeValues:{":o":JSON.stringify(p)}})),await m.send(new r.PutCommand({TableName:P,Item:{pollId:n,voterToken:u}}));let f=p.reduce((y,w)=>y+(w.votes||0),0);return t(200,{success:!0,poll:{question:i.question,options:p,totalVotes:f,showVoteCount:String(i.showVoteCount)!=="false"}},e)}return t(404,{error:"Not found"},e)}catch(n){return console.error("Error:",n),t(500,{error:"Internal server error"},e)}};0&&(module.exports={handler});
